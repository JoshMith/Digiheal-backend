// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER MANAGEMENT
// ==========================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  role          UserRole
  isActive      Boolean   @default(true)
  lastLogin     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relationships
  patient       Patient?
  staff         Staff?
  
  @@index([email])
  @@map("users")
}

enum UserRole {
  PATIENT
  STAFF
  ADMIN
}

// ==========================================
// PATIENT INFORMATION
// ==========================================

model Patient {
  id                String    @id @default(uuid())
  userId            String    @unique
  studentId         String    @unique
  firstName         String
  lastName          String
  dateOfBirth       DateTime
  gender            Gender
  phone             String
  nationality       String?
  address           String?
  bloodGroup        BloodGroup?
  
  // Emergency Contact
  emergencyContactName         String?
  emergencyContactRelationship String?
  emergencyContactPhone        String?
  emergencyContactEmail        String?
  
  // Insurance
  insuranceProvider String?
  policyNumber      String?
  
  // Medical Info
  allergies         String[]
  chronicConditions String[]
  currentMedications String[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relationships
  user                   User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments           Appointment[]
  healthAssessments      HealthAssessment[]
  medicalRecords         MedicalRecord[]
  prescriptions          Prescription[]
  vitals                 VitalSign[]
  notifications          Notification[]
  consultations          Consultation[]
  
  @@index([studentId])
  @@index([userId])
  @@map("patients")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodGroup {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

// ==========================================
// STAFF INFORMATION
// ==========================================

model Staff {
  id              String       @id @default(uuid())
  userId          String       @unique
  staffId         String       @unique
  firstName       String
  lastName        String
  phone           String
  department      Department
  position        StaffPosition
  specialization  String?
  licenseNumber   String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  // Relationships
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments    Appointment[]
  consultations   Consultation[]
  prescriptions   Prescription[]
  
  @@index([staffId])
  @@index([department])
  @@map("staff")
}

enum Department {
  GENERAL_MEDICINE
  CARDIOLOGY
  DERMATOLOGY
  ORTHOPEDICS
  GYNECOLOGY
  PEDIATRICS
  MENTAL_HEALTH
  EMERGENCY
  ADMINISTRATION
}

enum StaffPosition {
  SENIOR_DOCTOR
  JUNIOR_DOCTOR
  CONSULTANT
  NURSE
  ADMINISTRATOR
  RECEPTIONIST
}

// ==========================================
// HEALTH ASSESSMENTS (ML MODEL INTEGRATION)
// ==========================================

model HealthAssessment {
  id                String       @id @default(uuid())
  patientId         String
  
  // Input Data
  symptoms          String[]     // Array of symptom strings
  additionalInfo    Json?        // Age, gender, duration, severity, notes
  
  // ML Prediction Results
  predictedDisease  String
  severityScore     Int
  urgency           UrgencyLevel
  recommendations   String[]     // Workout/lifestyle recommendations
  confidence        Float?       // Optional: model confidence score
  
  assessmentDate    DateTime     @default(now())
  createdAt         DateTime     @default(now())
  
  // Relationships
  patient           Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  appointments      Appointment[] // Can trigger appointment creation
  
  @@index([patientId])
  @@index([assessmentDate])
  @@index([urgency])
  @@map("health_assessments")
}

enum UrgencyLevel {
  LOW
  MODERATE
  URGENT
}

// ==========================================
// APPOINTMENTS
// ==========================================

model Appointment {
  id                    String             @id @default(uuid())
  patientId             String
  staffId               String?
  healthAssessmentId    String?            // Link to assessment if created from one
  
  appointmentDate       DateTime
  appointmentTime       String
  duration              Int                @default(30) // minutes
  
  department            Department
  appointmentType       AppointmentType
  status                AppointmentStatus  @default(SCHEDULED)
  priority              Priority           @default(NORMAL)
  
  chiefComplaint        String
  symptoms              String[]
  notes                 String?
  
  // Queue Management
  queueNumber           Int?
  estimatedWaitTime     Int?               // minutes
  checkedInAt           DateTime?
  startedAt             DateTime?
  completedAt           DateTime?
  
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  
  // Relationships
  patient               Patient            @relation(fields: [patientId], references: [id])
  staff                 Staff?             @relation(fields: [staffId], references: [id])
  healthAssessment      HealthAssessment?  @relation(fields: [healthAssessmentId], references: [id])
  consultation          Consultation?
  
  @@index([patientId])
  @@index([staffId])
  @@index([appointmentDate])
  @@index([status])
  @@index([priority])
  @@map("appointments")
}

enum AppointmentType {
  CONSULTATION
  FOLLOW_UP
  CHECK_UP
  EMERGENCY
  VACCINATION
}

enum AppointmentStatus {
  SCHEDULED
  CHECKED_IN
  WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ==========================================
// CONSULTATIONS
// ==========================================

model Consultation {
  id                    String    @id @default(uuid())
  appointmentId         String    @unique
  patientId             String
  staffId               String
  
  // Examination
  chiefComplaint        String
  historyOfPresentIllness String?
  physicalExamination   Json?     // Structured examination findings
  
  // Diagnosis
  primaryDiagnosis      String?
  differentialDiagnosis String[]
  clinicalAssessment    String?
  
  // Treatment
  treatmentPlan         String?
  followUpInstructions  String?
  
  consultationDate      DateTime  @default(now())
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relationships
  appointment           Appointment @relation(fields: [appointmentId], references: [id])
  patient               Patient     @relation(fields: [patientId], references: [id])
  staff                 Staff       @relation(fields: [staffId], references: [id])
  prescriptions         Prescription[]
  vitalSigns            VitalSign[]
  
  @@index([patientId])
  @@index([staffId])
  @@index([consultationDate])
  @@map("consultations")
}

// ==========================================
// VITAL SIGNS
// ==========================================

model VitalSign {
  id                String        @id @default(uuid())
  patientId         String
  consultationId    String?
  
  bloodPressureSystolic   Int?
  bloodPressureDiastolic  Int?
  heartRate         Int?          // bpm
  temperature       Float?        // Celsius
  weight            Float?        // kg
  height            Float?        // cm
  oxygenSaturation  Int?          // percentage
  respiratoryRate   Int?          // breaths per minute
  bmi               Float?        // calculated
  
  recordedAt        DateTime      @default(now())
  recordedBy        String?       // Staff ID or system
  
  // Relationships
  patient           Patient       @relation(fields: [patientId], references: [id])
  consultation      Consultation? @relation(fields: [consultationId], references: [id])
  
  @@index([patientId])
  @@index([recordedAt])
  @@map("vital_signs")
}

// ==========================================
// PRESCRIPTIONS
// ==========================================

model Prescription {
  id                String       @id @default(uuid())
  patientId         String
  staffId           String
  consultationId    String?
  
  medicationName    String
  dosage            String
  frequency         String
  duration          String
  instructions      String?
  
  startDate         DateTime     @default(now())
  endDate           DateTime?
  status            PrescriptionStatus @default(ACTIVE)
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  // Relationships
  patient           Patient      @relation(fields: [patientId], references: [id])
  staff             Staff        @relation(fields: [staffId], references: [id])
  consultation      Consultation? @relation(fields: [consultationId], references: [id])
  
  @@index([patientId])
  @@index([status])
  @@map("prescriptions")
}

enum PrescriptionStatus {
  ACTIVE
  COMPLETED
  DISCONTINUED
  EXPIRED
}

// ==========================================
// MEDICAL RECORDS
// ==========================================

model MedicalRecord {
  id                String       @id @default(uuid())
  patientId         String
  
  recordType        RecordType
  title             String
  description       String?
  fileUrl           String?      // S3 or file storage URL
  metadata          Json?
  
  recordDate        DateTime
  createdAt         DateTime     @default(now())
  
  // Relationships
  patient           Patient      @relation(fields: [patientId], references: [id])
  
  @@index([patientId])
  @@index([recordType])
  @@index([recordDate])
  @@map("medical_records")
}

enum RecordType {
  LAB_RESULT
  IMAGING
  VACCINATION
  SURGERY
  DISCHARGE_SUMMARY
  OTHER
}

// ==========================================
// NOTIFICATIONS
// ==========================================

model Notification {
  id                String           @id @default(uuid())
  patientId         String
  
  type              NotificationType
  title             String
  message           String
  priority          Priority         @default(NORMAL)
  
  read              Boolean          @default(false)
  readAt            DateTime?
  
  createdAt         DateTime         @default(now())
  
  // Relationships
  patient           Patient          @relation(fields: [patientId], references: [id])
  
  @@index([patientId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  APPOINTMENT_REMINDER
  APPOINTMENT_CONFIRMATION
  LAB_RESULTS_READY
  MEDICATION_REMINDER
  URGENT_HEALTH_ALERT
  SYSTEM_ANNOUNCEMENT
  FOLLOW_UP_REQUIRED
}

// ==========================================
// SYSTEM SETTINGS & ANALYTICS
// ==========================================

model SystemSettings {
  id                String    @id @default(uuid())
  key               String    @unique
  value             Json
  description       String?
  
  updatedAt         DateTime  @updatedAt
  
  @@map("system_settings")
}

model AuditLog {
  id                String    @id @default(uuid())
  userId            String?
  action            String
  entity            String
  entityId          String?
  changes           Json?
  ipAddress         String?
  userAgent         String?
  
  createdAt         DateTime  @default(now())
  
  @@index([userId])
  @@index([createdAt])
  @@index([entity])
  @@map("audit_logs")
}